<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>เช็คอินอบรม</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Kanit',sans-serif}
  body{background:#0f172a;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:10px}
  .card{background:#fff;border-radius:28px;overflow:hidden;max-width:480px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,0.6)}
  .h{background:linear-gradient(135deg,#1d4ed8,#2563eb);color:#fff;text-align:center;padding:50px 20px}
  .h h1{font-size:28px;font-weight:700}
  .b{padding:30px}
  input{width:100%;padding:20px;font-size:20px;border:2px solid#ddd;border-radius:20px}
  input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 5px #dbeafe}
  .r{margin-top:15px;max-height:45vh;overflow-y:auto;border-radius:18px;background:#f8fafc}
  .i{padding:20px 22px;background:#fff;border-bottom:1px solid#eee;font-size:18px;cursor:pointer}
  .i:active{background:#dbeafe}
  .i strong{color:#1d4ed8}
  .info{margin-top:30px;padding:30px;background:#eff6ff;border-radius:20px;text-align:center;display:none}
  .info h2{font-size:30px;color:#1d4ed8}
  button{margin-top:25px;width:100%;padding:22px;font-size:24px;background:#1d4ed8;color:#fff;border:none;border-radius:20px;cursor:pointer}
  button:disabled{background:#94a3b8}
  .ok{display:none;text-align:center;padding:60px 20px}
  .ok h2{font-size:36px;color:#16a34a}
</style>
</head>
<body>
<div class="card">
  <div class="h"><h1>เช็คอินเข้าร่วมอบรม</h1><p style="margin-top:8px">พิมพ์รหัสหรือชื่อ</p></div>
  <div class="b" id="form">
    <input type="text" id="q" placeholder="ค้นหา..." autofocus>
    <div class="r" id="r"></div>
    <div class="info" id="info">
      <h2 id="n"></h2>
      <p id="d"></p>
      <p><strong>รหัส:</strong> <span id="id"></span></p>
      <button id="save">เข้าอบรม</button>
    </div>
  </div>
  <div class="ok" id="ok">
    <h2>เช็คอินสำเร็จ!</h2>
    <p id="nameok" style="font-size:28px;margin:15px 0;font-weight:600"></p>
    <p id="timeok" style="font-size:26px;color:#16a34a"></p>
    <button onclick="location.reload()" style="margin-top:30px;padding:18px;width:80%;font-size:22px">คนถัดไป</button>
  </div>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbwSe7ZZDkWcFUURUMpJkxvhvU0tOtMP9hJzgExaFYICZbW4pnlU4QgzjQkuAINDozZPcQ/exec";
let p = null;

document.getElementById('q').addEventListener('input',()=>{  
  let v=document.getElementById('q').value.trim();
  document.getElementById('info').style.display='none';
  document.getElementById('r').innerHTML=v.length<2?'':'<div class="i">กำลังค้นหา...</div>';
  if(v.length<2) return;

  fetch(`${URL}?action=search&keyword=${encodeURIComponent(v)}`)
    .then(r=>r.json())
    .then(d=>{
      document.getElementById('r').innerHTML='';
      d.forEach(x=>{
        let div=document.createElement('div');
        div.className='i';
        div.innerHTML=`<strong>${x.id}</strong> - ${x.name} ${x.surname}<br><small style="color:#666">${x.dept||'-'}</small>`;
        div.onclick=()=>{ p=x; document.getElementById('n').textContent=x.name+' '+x.surname; document.getElementById('d').textContent=x.dept||'-'; document.getElementById('id').textContent=x.id; document.getElementById('info').style.display='block'; document.getElementById('r').innerHTML=''; document.getElementById('q').value=`${x.id} - ${x.name} ${x.surname}`; document.getElementById('q').blur(); };
        document.getElementById('r').appendChild(div);
      });
      if(d.length===0) document.getElementById('r').innerHTML='<div class="i">ไม่พบข้อมูล</div>';
    });
});

document.getElementById('save').onclick=()=>{
  if(!p) return alert('กรุณาเลือกพนักงาน');
  document.getElementById('save').disabled=true;
  document.getElementById('save').textContent='กำลังบันทึก...';

  fetch(URL,{
    method:'POST',
    body:JSON.stringify({action:'checkin',id:p.id,name:p.name,surname:p.surname,dept:p.dept||''}),
    headers:{'Content-Type':'application/json'}
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.success){
      document.getElementById('form').style.display='none';
      document.getElementById('nameok').textContent=p.name+' '+p.surname;
      document.getElementById('timeok').textContent=new Date().toLocaleString('th-TH');
      document.getElementById('ok').style.display='block';
    }else{
      alert('ผิดพลาด: '+(res.message||'ไม่ทราบ'));
      document.getElementById('save').disabled=false;
      document.getElementById('save').textContent='เข้าอบรม';
    }
  });
};
</script>
</body>
</html>
