<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>เข้าร่วมกิจกรรม</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#003087;--primary-light:#0044cc;--accent:#0066ff;--gray-border:#e2e8f0;--text:#1e293b;--text-light:#64748b;--shadow:0 20px 40px rgba(0,48,135,.12)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Prompt',sans-serif;background:linear-gradient(135deg,#f0f4ff,#e6ecff);min-height:100vh;padding:20px 12px;display:flex;justify-content:center;align-items:flex-start}
        .container{background:#fff;width:100%;max-width:480px;border-radius:20px;overflow:hidden;box-shadow:var(--shadow);border:1px solid rgba(0,48,135,.08)}
        .header{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;padding:36px 24px;text-align:center}
        .header h2{font-size:1.9rem;font-weight:700}
        .header p{margin-top:10px;font-size:1.02rem;opacity:.95}
        .content{padding:32px 28px}
        .search-box{position:relative;margin-bottom:20px}
        #idInput{width:100%;padding:19px 24px;font-size:1.15rem;border:2px solid var(--gray-border);border-radius:16px;background:#fcfdff;transition:all .35s}
        #idInput:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 5px rgba(0,102,255,.15);transform:translateY(-2px);background:#fff}
        #searchResults{position:absolute;top:100%;left:0;right:0;background:#fff;border-radius:0 0 16px 16px;max-height:360px;overflow-y:auto;box-shadow:var(--shadow);border:2px solid var(--accent);border-top:none;opacity:0;visibility:hidden;transform:translateY(-12px);transition:all .35s;z-index:10}
        #searchResults.show{opacity:1;visibility:visible;transform:translateY(0)}
        .result-item{padding:18px 24px;border-bottom:1px solid #f1f5f9;cursor:pointer;transition:all .25s}
        .result-item:hover{background:linear-gradient(to right,#f0f7ff,#e8f1ff);padding-left:32px}
        .result-item:last-child{border-bottom:none;border-radius:0 0 14px 14px}
        .item-name{font-weight:600;color:var(--text);font-size:1.1rem}
        .item-details{color:var(--text-light);font-size:.96rem;margin-top:6px}
        #result{padding:20px;border-radius:14px;font-size:1.08rem;text-align:center;min-height:70px;display:flex;align-items:center;justify-content:center;font-weight:500;line-height:1.5;opacity:0;transition:all .5s}
        #result.visible{opacity:1}
        .success{background:linear-gradient(to right,#edf7ed,#e0f2e0);color:#2d6a2d;border:1px solid #c8e6c9}
        .error{background:linear-gradient(to right,#fdecea,#fce0dd);color:#c62828;border:1px solid #ef9a9a}
        .loading{color:var(--primary);background:#ebf3ff;border:1px solid #90caf9}
        .info{background:#fff8e1;color:#ff8f00;border:1px solid #ffe082}
        @media(max-width:480px){.header{padding:30px 20px}.header h2{font-size:1.75rem}.content{padding:28px 22px}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>เข้าร่วมกิจกรรม</h2>
            <p>พิมพ์ชื่อหรือรหัสพนักงานเพื่อลงทะเบียน</p>
        </div>
        <div class="content">
            <div class="search-box">
                <input type="text" id="idInput" placeholder="ค้นหาชื่อหรือรหัสพนักงาน..." autocomplete="off">
                <ul id="searchResults"></ul>
            </div>
            <div id="result" class="visible info">กรุณาพิมพ์ชื่อหรือรหัสพนักงานเพื่อค้นหา</div>
        </div>
    </div>

    <script>
        // เปลี่ยนตรงนี้แค่บรรทัดเดียว! ใส่ Web App URL ของคุณ
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwVPBxWASqL1sNlVXX_jb2mYc4289hIRX96BFfndRH7Tuak_PbM6TNOLnM4TK4m_MasTg/exec";
        // ตัวอย่างจริง: https://script.google.com/macros/s/AKfycbz0L...Z9k/exec

        const resultDiv = document.getElementById('result');
        const inputField = document.getElementById('idInput');
        const resultsList = document.getElementById('searchResults');
        let timer;

        inputField.addEventListener('input', () => {
            clearTimeout(timer);
            timer = setTimeout(startSearch, 350);
        });

        async function startSearch() {
            const q = inputField.value.trim();
            resultsList.innerHTML = '';
            resultsList.classList.remove('show');

            if (q.length < 2) {
                showResult({status:'info', message:'พิมพ์อย่างน้อย 2 ตัวอักษร'});
                return;
            }

            showResult({status:'loading', message:'กำลังค้นหา...'});

            try {
                const res = await fetch(`${WEB_APP_URL}?action=search&q=${encodeURIComponent(q)}`);
                const data = await res.json();

                if (data.status === 'error') throw new Error(data.message);
                if (!data || data.length === 0) throw new Error('ไม่พบข้อมูลที่ตรงกัน');

                resultsList.innerHTML = '';
                data.forEach(emp => {
                    const li = document.createElement('li');
                    li.className = 'result-item';
                    li.innerHTML = `<div class="item-name">${emp.name}</div>
                                    <div class="item-details">รหัส: ${emp.id} | แผนก: ${emp.dept}</div>`;
                    li.onclick = () => doCheckin(emp.id, emp.name);
                    resultsList.appendChild(li);
                });
                resultsList.classList.add('show');

            } catch (e) {
                showResult({status:'error', message: e.message || 'เกิดข้อผิดพลาดในการเชื่อมต่อ'});
            }
        }

        async function doCheckin(id, name) {
            resultsList.classList.remove('show');
            inputField.value = name;

            showResult({status:'loading', message:`กำลังบันทึก<br><strong>${name}</strong>...`});

            try {
                const res = await fetch(`${WEB_APP_URL}?action=checkin&id=${id}`);
                const data = await res.json();

                showResult(data);   // data จะมี {status:"success", message:"..."} หรือ {status:"error", message:"..."}

                if (data.status === 'success') {
                    inputField.value = '';
                    setTimeout(() => inputField.focus(), 800);
                }
            } catch (e) {
                showResult({status:'error', message:'บันทึกไม่สำเร็จ กรุณาลองใหม่'});
            }
        }

        function showResult(obj) {
            resultDiv.innerHTML = obj.message;
            resultDiv.className = 'visible ' + obj.status;
        }

        document.addEventListener('click', e => {
            if (!e.target.closest('.search-box')) resultsList.classList.remove('show');
        });

        window.onload = () => inputField.focus();
    </script>
</body>
</html>
